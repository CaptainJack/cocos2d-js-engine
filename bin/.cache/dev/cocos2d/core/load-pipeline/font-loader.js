
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/load-pipeline/font-loader.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var textUtils = require('../utils/text-utils');

var _canvasContext = null; // letter symbol number CJK

var _testString = "BES bswy:->@123\u4E01\u3041\u1101";
var _fontFaces = {};

var _intervalId = -1;

var _loadingFonts = []; // 60 seconds timeout

var _timeout = 60000; // Refer to https://github.com/typekit/webfontloader/blob/master/src/core/fontwatcher.js

var useNativeCheck = function () {
  var nativeCheck = undefined;
  return function () {
    if (nativeCheck === undefined) {
      if (!!window.FontFace) {
        var match = /Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent);
        var safari10Match = /OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent) && /Apple/.exec(window.navigator.vendor);

        if (match) {
          nativeCheck = parseInt(match[1], 10) > 42;
        } else if (safari10Match) {
          nativeCheck = false;
        } else {
          nativeCheck = true;
        }
      } else {
        nativeCheck = false;
      }
    }

    return nativeCheck;
  };
}();

function _checkFontLoaded() {
  var allFontsLoaded = true;
  var now = Date.now();

  for (var i = _loadingFonts.length - 1; i >= 0; i--) {
    var fontLoadHandle = _loadingFonts[i];
    var fontFamily = fontLoadHandle.fontFamilyName; // load timeout

    if (now - fontLoadHandle.startTime > _timeout) {
      cc.warnID(4933, fontFamily);
      fontLoadHandle.callback(null, fontFamily);

      _loadingFonts.splice(i, 1);

      continue;
    }

    var oldWidth = fontLoadHandle.refWidth;
    var fontDesc = '40px ' + fontFamily;
    _canvasContext.font = fontDesc;
    var newWidth = textUtils.safeMeasureText(_canvasContext, _testString, fontDesc); // loaded successfully

    if (oldWidth !== newWidth) {
      _loadingFonts.splice(i, 1);

      fontLoadHandle.callback(null, fontFamily);
    } else {
      allFontsLoaded = false;
    }
  }

  if (allFontsLoaded) {
    clearInterval(_intervalId);
    _intervalId = -1;
  }
} // refer to https://github.com/typekit/webfontloader/blob/master/src/core/nativefontwatchrunner.js


function nativeCheckFontLoaded(start, font, callback) {
  var loader = new Promise(function (resolve, reject) {
    var check = function check() {
      var now = Date.now();

      if (now - start >= _timeout) {
        reject();
      } else {
        document.fonts.load('40px ' + font).then(function (fonts) {
          if (fonts.length >= 1) {
            resolve();
          } else {
            setTimeout(check, 100);
          }
        }, function () {
          reject();
        });
      }
    };

    check();
  });
  var timeoutId = null,
      timer = new Promise(function (resolve, reject) {
    timeoutId = setTimeout(reject, _timeout);
  });
  Promise.race([timer, loader]).then(function () {
    if (timeoutId) {
      clearTimeout(timeoutId);
      timeoutId = null;
    }

    callback(null, font);
  }, function () {
    cc.warnID(4933, font);
    callback(null, font);
  });
}

var fontLoader = {
  loadFont: function loadFont(item, callback) {
    var url = item.url;

    var fontFamilyName = fontLoader._getFontFamily(url); // Already loaded fonts


    if (_fontFaces[fontFamilyName]) {
      return fontFamilyName;
    }

    if (!_canvasContext) {
      var labelCanvas = document.createElement('canvas');
      labelCanvas.width = 100;
      labelCanvas.height = 100;
      _canvasContext = labelCanvas.getContext('2d');
    } // Default width reference to test whether new font is loaded correctly


    var fontDesc = '40px ' + fontFamilyName;
    _canvasContext.font = fontDesc;
    var refWidth = textUtils.safeMeasureText(_canvasContext, _testString, fontDesc); // Setup font face style

    var fontStyle = document.createElement("style");
    fontStyle.type = "text/css";
    var fontStr = "";
    if (isNaN(fontFamilyName - 0)) fontStr += "@font-face { font-family:" + fontFamilyName + "; src:";else fontStr += "@font-face { font-family:'" + fontFamilyName + "'; src:";
    fontStr += "url('" + url + "');";
    fontStyle.textContent = fontStr + "}";
    document.body.appendChild(fontStyle); // Preload font with div

    var preloadDiv = document.createElement("div");
    var divStyle = preloadDiv.style;
    divStyle.fontFamily = fontFamilyName;
    preloadDiv.innerHTML = ".";
    divStyle.position = "absolute";
    divStyle.left = "-100px";
    divStyle.top = "-100px";
    document.body.appendChild(preloadDiv);

    if (useNativeCheck()) {
      nativeCheckFontLoaded(Date.now(), fontFamilyName, callback);
    } else {
      // Save loading font
      var fontLoadHandle = {
        fontFamilyName: fontFamilyName,
        refWidth: refWidth,
        callback: callback,
        startTime: Date.now()
      };

      _loadingFonts.push(fontLoadHandle);

      if (_intervalId === -1) {
        _intervalId = setInterval(_checkFontLoaded, 100);
      }
    }

    _fontFaces[fontFamilyName] = fontStyle;
  },
  _getFontFamily: function _getFontFamily(fontHandle) {
    var ttfIndex = fontHandle.lastIndexOf(".ttf");
    if (ttfIndex === -1) return fontHandle;
    var slashPos = fontHandle.lastIndexOf("/");
    var fontFamilyName;

    if (slashPos === -1) {
      fontFamilyName = fontHandle.substring(0, ttfIndex) + "_LABEL";
    } else {
      fontFamilyName = fontHandle.substring(slashPos + 1, ttfIndex) + "_LABEL";
    }

    if (fontFamilyName.indexOf(' ') !== -1) {
      fontFamilyName = '"' + fontFamilyName + '"';
    }

    return fontFamilyName;
  }
};
module.exports = fontLoader;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZvbnQtbG9hZGVyLmpzIl0sIm5hbWVzIjpbInRleHRVdGlscyIsInJlcXVpcmUiLCJfY2FudmFzQ29udGV4dCIsIl90ZXN0U3RyaW5nIiwiX2ZvbnRGYWNlcyIsIl9pbnRlcnZhbElkIiwiX2xvYWRpbmdGb250cyIsIl90aW1lb3V0IiwidXNlTmF0aXZlQ2hlY2siLCJuYXRpdmVDaGVjayIsInVuZGVmaW5lZCIsIndpbmRvdyIsIkZvbnRGYWNlIiwibWF0Y2giLCJleGVjIiwibmF2aWdhdG9yIiwidXNlckFnZW50Iiwic2FmYXJpMTBNYXRjaCIsInZlbmRvciIsInBhcnNlSW50IiwiX2NoZWNrRm9udExvYWRlZCIsImFsbEZvbnRzTG9hZGVkIiwibm93IiwiRGF0ZSIsImkiLCJsZW5ndGgiLCJmb250TG9hZEhhbmRsZSIsImZvbnRGYW1pbHkiLCJmb250RmFtaWx5TmFtZSIsInN0YXJ0VGltZSIsImNjIiwid2FybklEIiwiY2FsbGJhY2siLCJzcGxpY2UiLCJvbGRXaWR0aCIsInJlZldpZHRoIiwiZm9udERlc2MiLCJmb250IiwibmV3V2lkdGgiLCJzYWZlTWVhc3VyZVRleHQiLCJjbGVhckludGVydmFsIiwibmF0aXZlQ2hlY2tGb250TG9hZGVkIiwic3RhcnQiLCJsb2FkZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImNoZWNrIiwiZG9jdW1lbnQiLCJmb250cyIsImxvYWQiLCJ0aGVuIiwic2V0VGltZW91dCIsInRpbWVvdXRJZCIsInRpbWVyIiwicmFjZSIsImNsZWFyVGltZW91dCIsImZvbnRMb2FkZXIiLCJsb2FkRm9udCIsIml0ZW0iLCJ1cmwiLCJfZ2V0Rm9udEZhbWlseSIsImxhYmVsQ2FudmFzIiwiY3JlYXRlRWxlbWVudCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2V0Q29udGV4dCIsImZvbnRTdHlsZSIsInR5cGUiLCJmb250U3RyIiwiaXNOYU4iLCJ0ZXh0Q29udGVudCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsInByZWxvYWREaXYiLCJkaXZTdHlsZSIsInN0eWxlIiwiaW5uZXJIVE1MIiwicG9zaXRpb24iLCJsZWZ0IiwidG9wIiwicHVzaCIsInNldEludGVydmFsIiwiZm9udEhhbmRsZSIsInR0ZkluZGV4IiwibGFzdEluZGV4T2YiLCJzbGFzaFBvcyIsInN1YnN0cmluZyIsImluZGV4T2YiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXlCQSxJQUFNQSxTQUFTLEdBQUdDLE9BQU8sQ0FBQyxxQkFBRCxDQUF6Qjs7QUFFQSxJQUFJQyxjQUFjLEdBQUcsSUFBckIsRUFDQTs7QUFDQSxJQUFJQyxXQUFXLEdBQUcsbUNBQWxCO0FBRUEsSUFBSUMsVUFBVSxHQUFHLEVBQWpCOztBQUNBLElBQUlDLFdBQVcsR0FBRyxDQUFDLENBQW5COztBQUNBLElBQUlDLGFBQWEsR0FBRyxFQUFwQixFQUNBOztBQUNBLElBQUlDLFFBQVEsR0FBRyxLQUFmLEVBRUE7O0FBQ0EsSUFBSUMsY0FBYyxHQUFJLFlBQVk7QUFDOUIsTUFBSUMsV0FBVyxHQUFHQyxTQUFsQjtBQUNBLFNBQU8sWUFBWTtBQUNmLFFBQUlELFdBQVcsS0FBS0MsU0FBcEIsRUFBK0I7QUFDM0IsVUFBSSxDQUFDLENBQUNDLE1BQU0sQ0FBQ0MsUUFBYixFQUF1QjtBQUNuQixZQUFJQyxLQUFLLEdBQUcsd0JBQXdCQyxJQUF4QixDQUE2QkgsTUFBTSxDQUFDSSxTQUFQLENBQWlCQyxTQUE5QyxDQUFaO0FBQ0EsWUFBSUMsYUFBYSxHQUFHLDhCQUE4QkgsSUFBOUIsQ0FBbUNILE1BQU0sQ0FBQ0ksU0FBUCxDQUFpQkMsU0FBcEQsS0FBa0UsUUFBUUYsSUFBUixDQUFhSCxNQUFNLENBQUNJLFNBQVAsQ0FBaUJHLE1BQTlCLENBQXRGOztBQUVBLFlBQUlMLEtBQUosRUFBVztBQUNQSixVQUFBQSxXQUFXLEdBQUdVLFFBQVEsQ0FBQ04sS0FBSyxDQUFDLENBQUQsQ0FBTixFQUFXLEVBQVgsQ0FBUixH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QU9ELFVBQVA7QUFFckIsUUFBSUcsUUFBUSxHQUFHSCxVQUFVLENBQUNFLFdBQVgsQ0FBdUIsR0FBdkIsQ0FBZjtBQUNBLFFBQUl6RCxjQUFKOztBQUNBLFFBQUkwRCxRQUFRLEtBQUssQ0FBQyxDQUFsQixFQUFxQjtBQUNqQjFELE1BQUFBLGNBQWMsR0FBR3VELFVBQVUsQ0FBQ0ksU0FBWCxDQUFxQixDQUFyQixFQUF3QkgsUUFBeEIsSUFBb0MsUUFBckQ7QUFDSCxLQUZELE1BRU87QUFDSHhELE1BQUFBLGNBQWMsR0FBR3VELFVBQVUsQ0FBQ0ksU0FBWCxDQUFxQkQsUUFBUSxHQUFHLENBQWhDLEVBQW1DRixRQUFuQyxJQUErQyxRQUFoRTtBQUNIOztBQUNELFFBQUl4RCxjQUFjLENBQUM0RCxPQUFmLENBQXVCLEdBQXZCLE1BQWdDLENBQUMsQ0FBckMsRUFBd0M7QUFDcEM1RCxNQUFBQSxjQUFjLEdBQUcsTUFBTUEsY0FBTixHQUF1QixHQUF4QztBQUNIOztBQUNELFdBQU9BLGNBQVA7QUFDSDtBQS9FWSxDQUFqQjtBQWtGQTZELE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmpDLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiBDb3B5cmlnaHQgKGMpIDIwMTctMjAxOCBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cblxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cblxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcbiAgd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXG4gIG5vdCB1c2UgQ29jb3MgQ3JlYXRvciBzb2Z0d2FyZSBmb3IgZGV2ZWxvcGluZyBvdGhlciBzb2Z0d2FyZSBvciB0b29scyB0aGF0J3NcbiAgdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxuICBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cblxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cblxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4gVEhFIFNPRlRXQVJFLlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5cbmNvbnN0IHRleHRVdGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzL3RleHQtdXRpbHMnKTtcblxubGV0IF9jYW52YXNDb250ZXh0ID0gbnVsbDtcbi8vIGxldHRlciBzeW1ib2wgbnVtYmVyIENKS1xubGV0IF90ZXN0U3RyaW5nID0gXCJCRVMgYnN3eTotPkAxMjNcXHU0RTAxXFx1MzA0MVxcdTExMDFcIjtcblxubGV0IF9mb250RmFjZXMgPSB7fTtcbmxldCBfaW50ZXJ2YWxJZCA9IC0xO1xubGV0IF9sb2FkaW5nRm9udHMgPSBbXTtcbi8vIDYwIHNlY29uZHMgdGltZW91dFxubGV0IF90aW1lb3V0ID0gNjAwMDA7XG5cbi8vIFJlZmVyIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS90eXBla2l0L3dlYmZvbnRsb2FkZXIvYmxvYi9tYXN0ZXIvc3JjL2NvcmUvZm9udHdhdGNoZXIuanNcbmxldCB1c2VOYXRpdmVDaGVjayA9IChmdW5jdGlvbiAoKSB7XG4gICAgdmFyIG5hdGl2ZUNoZWNrID0gdW5kZWZpbmVkO1xuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChuYXRpdmVDaGVjayA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoISF3aW5kb3cuRm9udEZhY2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSAvR2Vja28uKkZpcmVmb3hcXC8oXFxkKykvLmV4ZWMod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpO1xuICAgICAgICAgICAgICAgIHZhciBzYWZhcmkxME1hdGNoID0gL09TIFguKlZlcnNpb25cXC8xMFxcLi4qU2FmYXJpLy5leGVjKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KSAmJiAvQXBwbGUvLmV4ZWMod2luZG93Lm5hdmlnYXRvci52ZW5kb3IpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSBwYXJzZUludChtYXRjaFsxXSwgMTApID4gNDI7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChzYWZhcmkxME1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hdGl2ZUNoZWNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5hdGl2ZUNoZWNrID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmF0aXZlQ2hlY2s7XG4gICAgICAgIFxuICAgIH1cbn0pKCk7XG5cbmZ1bmN0aW9uIF9jaGVja0ZvbnRMb2FkZWQgKCkge1xuICAgIGxldCBhbGxGb250c0xvYWRlZCA9IHRydWU7XG4gICAgbGV0IG5vdyA9IERhdGUubm93KCk7XG5cbiAgICBmb3IgKGxldCBpID0gX2xvYWRpbmdGb250cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICBsZXQgZm9udExvYWRIYW5kbGUgPSBfbG9hZGluZ0ZvbnRzW2ldO1xuICAgICAgICBsZXQgZm9udEZhbWlseSA9IGZvbnRMb2FkSGFuZGxlLmZvbnRGYW1pbHlOYW1lO1xuICAgICAgICAvLyBsb2FkIHRpbWVvdXRcbiAgICAgICAgaWYgKG5vdyAtIGZvbnRMb2FkSGFuZGxlLnN0YXJ0VGltZSA+IF90aW1lb3V0KSB7XG4gICAgICAgICAgICBjYy53YXJuSUQoNDkzMywgZm9udEZhbWlseSk7XG4gICAgICAgICAgICBmb250TG9hZEhhbmRsZS5jYWxsYmFjayhudWxsLCBmb250RmFtaWx5KTtcbiAgICAgICAgICAgIF9sb2FkaW5nRm9udHMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgb2xkV2lkdGggPSBmb250TG9hZEhhbmRsZS5yZWZXaWR0aDtcbiAgICAgICAgbGV0IGZvbnREZXNjID0gJzQwcHggJyArIGZvbnRGYW1pbHk7XG4gICAgICAgIF9jYW52YXNDb250ZXh0LmZvbnQgPSBmb250RGVzYztcbiAgICAgICAgbGV0IG5ld1dpZHRoID0gdGV4dFV0aWxzLnNhZmVNZWFzdXJlVGV4dChfY2FudmFzQ29udGV4dCwgX3Rlc3RTdHJpbmcsIGZvbnREZXNjKTtcbiAgICAgICAgLy8gbG9hZGVkIHN1Y2Nlc3NmdWxseVxuICAgICAgICBpZiAob2xkV2lkdGggIT09IG5ld1dpZHRoKSB7XG4gICAgICAgICAgICBfbG9hZGluZ0ZvbnRzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgIGZvbnRMb2FkSGFuZGxlLmNhbGxiYWNrKG51bGwsIGZvbnRGYW1pbHkpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgYWxsRm9udHNMb2FkZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmIChhbGxGb250c0xvYWRlZCkge1xuICAgICAgICBjbGVhckludGVydmFsKF9pbnRlcnZhbElkKTtcbiAgICAgICAgX2ludGVydmFsSWQgPSAtMTtcbiAgICB9XG59XG5cbi8vIHJlZmVyIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS90eXBla2l0L3dlYmZvbnRsb2FkZXIvYmxvYi9tYXN0ZXIvc3JjL2NvcmUvbmF0aXZlZm9udHdhdGNocnVubmVyLmpzXG5mdW5jdGlvbiBuYXRpdmVDaGVja0ZvbnRMb2FkZWQgKHN0YXJ0LCBmb250LCBjYWxsYmFjaykge1xuICAgIHZhciBsb2FkZXIgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHZhciBjaGVjayA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpO1xuXG4gICAgICAgICAgICBpZiAobm93IC0gc3RhcnQgPj0gX3RpbWVvdXQpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoKTtcbiAgICAgICAgICAgIH0gXG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5mb250cy5sb2FkKCc0MHB4ICcgKyBmb250KS50aGVuKGZ1bmN0aW9uIChmb250cykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZm9udHMubGVuZ3RoID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGNoZWNrLCAxMDApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBjaGVjaygpO1xuICAgIH0pO1xuICBcbiAgICB2YXIgdGltZW91dElkID0gbnVsbCxcbiAgICB0aW1lciA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dChyZWplY3QsIF90aW1lb3V0KTtcbiAgICB9KTtcbiAgXG4gICAgUHJvbWlzZS5yYWNlKFt0aW1lciwgbG9hZGVyXSkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICh0aW1lb3V0SWQpIHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuICAgICAgICAgICAgdGltZW91dElkID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgZm9udCk7XG4gICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICBjYy53YXJuSUQoNDkzMywgZm9udCk7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGZvbnQpO1xuICAgIH0pO1xufVxuXG52YXIgZm9udExvYWRlciA9IHtcbiAgICBsb2FkRm9udDogZnVuY3Rpb24gKGl0ZW0sIGNhbGxiYWNrKSB7XG4gICAgICAgIGxldCB1cmwgPSBpdGVtLnVybDtcbiAgICAgICAgbGV0IGZvbnRGYW1pbHlOYW1lID0gZm9udExvYWRlci5fZ2V0Rm9udEZhbWlseSh1cmwpO1xuXG4gICAgICAgIC8vIEFscmVhZHkgbG9hZGVkIGZvbnRzXG4gICAgICAgIGlmIChfZm9udEZhY2VzW2ZvbnRGYW1pbHlOYW1lXSkge1xuICAgICAgICAgICAgcmV0dXJuIGZvbnRGYW1pbHlOYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfY2FudmFzQ29udGV4dCkge1xuICAgICAgICAgICAgbGV0IGxhYmVsQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgICAgICAgICBsYWJlbENhbnZhcy53aWR0aCA9IDEwMDtcbiAgICAgICAgICAgIGxhYmVsQ2FudmFzLmhlaWdodCA9IDEwMDtcbiAgICAgICAgICAgIF9jYW52YXNDb250ZXh0ID0gbGFiZWxDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gRGVmYXVsdCB3aWR0aCByZWZlcmVuY2UgdG8gdGVzdCB3aGV0aGVyIG5ldyBmb250IGlzIGxvYWRlZCBjb3JyZWN0bHlcbiAgICAgICAgbGV0IGZvbnREZXNjID0gJzQwcHggJyArIGZvbnRGYW1pbHlOYW1lO1xuICAgICAgICBfY2FudmFzQ29udGV4dC5mb250ID0gZm9udERlc2M7XG4gICAgICAgIGxldCByZWZXaWR0aCA9IHRleHRVdGlscy5zYWZlTWVhc3VyZVRleHQoX2NhbnZhc0NvbnRleHQsIF90ZXN0U3RyaW5nLCBmb250RGVzYyk7XG5cbiAgICAgICAgLy8gU2V0dXAgZm9udCBmYWNlIHN0eWxlXG4gICAgICAgIGxldCBmb250U3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3R5bGVcIik7XG4gICAgICAgIGZvbnRTdHlsZS50eXBlID0gXCJ0ZXh0L2Nzc1wiO1xuICAgICAgICBsZXQgZm9udFN0ciA9IFwiXCI7XG4gICAgICAgIGlmIChpc05hTihmb250RmFtaWx5TmFtZSAtIDApKVxuICAgICAgICAgICAgZm9udFN0ciArPSBcIkBmb250LWZhY2UgeyBmb250LWZhbWlseTpcIiArIGZvbnRGYW1pbHlOYW1lICsgXCI7IHNyYzpcIjtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgZm9udFN0ciArPSBcIkBmb250LWZhY2UgeyBmb250LWZhbWlseTonXCIgKyBmb250RmFtaWx5TmFtZSArIFwiJzsgc3JjOlwiO1xuICAgICAgICBmb250U3RyICs9IFwidXJsKCdcIiArIHVybCArIFwiJyk7XCI7XG4gICAgICAgIGZvbnRTdHlsZS50ZXh0Q29udGVudCA9IGZvbnRTdHIgKyBcIn1cIjtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmb250U3R5bGUpO1xuXG4gICAgICAgIC8vIFByZWxvYWQgZm9udCB3aXRoIGRpdlxuICAgICAgICBsZXQgcHJlbG9hZERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgIGxldCBkaXZTdHlsZSA9IHByZWxvYWREaXYuc3R5bGU7XG4gICAgICAgIGRpdlN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5TmFtZTtcbiAgICAgICAgcHJlbG9hZERpdi5pbm5lckhUTUwgPSBcIi5cIjtcbiAgICAgICAgZGl2U3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG4gICAgICAgIGRpdlN0eWxlLmxlZnQgPSBcIi0xMDBweFwiO1xuICAgICAgICBkaXZTdHlsZS50b3AgPSBcIi0xMDBweFwiO1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHByZWxvYWREaXYpO1xuXG4gICAgICAgIGlmICh1c2VOYXRpdmVDaGVjaygpKSB7XG4gICAgICAgICAgICBuYXRpdmVDaGVja0ZvbnRMb2FkZWQoRGF0ZS5ub3coKSwgZm9udEZhbWlseU5hbWUsIGNhbGxiYWNrKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIFNhdmUgbG9hZGluZyBmb250XG4gICAgICAgICAgICBsZXQgZm9udExvYWRIYW5kbGUgPSB7XG4gICAgICAgICAgICAgICAgZm9udEZhbWlseU5hbWUsXG4gICAgICAgICAgICAgICAgcmVmV2lkdGgsXG4gICAgICAgICAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lOiBEYXRlLm5vdygpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfbG9hZGluZ0ZvbnRzLnB1c2goZm9udExvYWRIYW5kbGUpO1xuICAgICAgICAgICAgaWYgKF9pbnRlcnZhbElkID09PSAtMSkge1xuICAgICAgICAgICAgICAgIF9pbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoX2NoZWNrRm9udExvYWRlZCwgMTAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBfZm9udEZhY2VzW2ZvbnRGYW1pbHlOYW1lXSA9IGZvbnRTdHlsZTtcbiAgICAgICAgXG4gICAgfSxcblxuICAgIF9nZXRGb250RmFtaWx5OiBmdW5jdGlvbiAoZm9udEhhbmRsZSkge1xuICAgICAgICB2YXIgdHRmSW5kZXggPSBmb250SGFuZGxlLmxhc3RJbmRleE9mKFwiLnR0ZlwiKTtcbiAgICAgICAgaWYgKHR0ZkluZGV4ID09PSAtMSkgcmV0dXJuIGZvbnRIYW5kbGU7XG5cbiAgICAgICAgdmFyIHNsYXNoUG9zID0gZm9udEhhbmRsZS5sYXN0SW5kZXhPZihcIi9cIik7XG4gICAgICAgIHZhciBmb250RmFtaWx5TmFtZTtcbiAgICAgICAgaWYgKHNsYXNoUG9zID09PSAtMSkge1xuICAgICAgICAgICAgZm9udEZhbWlseU5hbWUgPSBmb250SGFuZGxlLnN1YnN0cmluZygwLCB0dGZJbmRleCkgKyBcIl9MQUJFTFwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9udEZhbWlseU5hbWUgPSBmb250SGFuZGxlLnN1YnN0cmluZyhzbGFzaFBvcyArIDEsIHR0ZkluZGV4KSArIFwiX0xBQkVMXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvbnRGYW1pbHlOYW1lLmluZGV4T2YoJyAnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIGZvbnRGYW1pbHlOYW1lID0gJ1wiJyArIGZvbnRGYW1pbHlOYW1lICsgJ1wiJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZm9udEZhbWlseU5hbWU7XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBmb250TG9hZGVyIl19